<!--
--------
Página de inicio
--------
-->

<ion-header [translucent]="true">
  <ion-toolbar class="toolbar-blur">
    <ion-buttons slot="start">
      <ion-button (click)="toggleMenu()" class="menu-button" aria-label="Abrir menú">
        <ion-icon slot="icon-only" name="menu"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Inicio</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="goToProfile()" class="profile-button">
        <ion-icon slot="start" name="person"></ion-icon>
        <span>Perfil</span>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <div class="header-container">
    <h1>Caleuche Network</h1>
    <h2>Donde lo desconocido sale a flote</h2>
  </div>
  <!-- Formulario para publicar -->
  <section class="composer-section">
    <ion-card class="composer-card">
      <ion-card-header>
        <ion-card-title>Publicar en el foro</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-item>
          <ion-label position="stacked">Título</ion-label>
          <ion-input [(ngModel)]="newTitle" placeholder="Título breve"></ion-input>
        </ion-item>
        <ion-item>
          <ion-label position="stacked">Contenido</ion-label>
          <ion-textarea [(ngModel)]="newContent" placeholder="Cuenta tu experiencia..." rows="4"></ion-textarea>
        </ion-item>
        <div class="composer-actions">
          <ion-button expand="block" (click)="publish()" [disabled]="!newTitle || !newContent">Publicar</ion-button>
        </div>
      </ion-card-content>
    </ion-card>
  </section>

  <!-- Listado de publicaciones -->
  <section class="feed-section" #feedSection>
    <!-- Side menu (local to home) -->
    <div class="menu-backdrop" *ngIf="menuOpen" (click)="closeMenu()"></div>
    <nav class="side-menu" [class.open]="menuOpen" role="navigation" aria-hidden="{{!menuOpen}}">
      <ul>
        <li><button ion-button (click)="goToHome(); closeMenu()"><ion-icon name="home"></ion-icon> Inicio</button></li>
        <li><button ion-button (click)="goToProfile(); closeMenu()"><ion-icon name="person"></ion-icon> Perfil</button></li>
        <li><button ion-button (click)="goToLore(); closeMenu()"><ion-icon name="menu"></ion-icon> Contenido</button></li>
        <li class="logout-item"><button ion-button (click)="logout(); closeMenu()"><ion-icon name="log-out"></ion-icon> Cerrar sesión</button></li>
      </ul>
    </nav>
    <h1 class="feed-title">Descubre los nuevos misterios</h1>
    
    <!-- Flecha para desplazarse -->
    <div class="scroll-arrow-container">
      <button class="scroll-arrow" (click)="scrollToFeed()" aria-label="Desplazarse a publicaciones">
        <!-- Triángulo minimalista -->
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg">
          <polygon points="12,16 6,8 18,8" />
        </svg>
      </button>
    </div>

    <ion-list>
      <ion-item *ngFor="let item of items" lines="none" class="fade-in-item post-item">
        <ion-avatar slot="start">
          <img [src]="item.image" alt="Avatar" />
        </ion-avatar>

        <ion-label class="post-body">
          <div class="post-header">
            <h4 class="post-username">{{ item.username || 'Anónimo' }}</h4>
            <small class="post-meta">{{ item.date | date:'short' }}</small>
          </div>
          <h3>{{ item.title }}</h3>
          <p class="post-content">{{ item.content }}</p>

          <!-- Área de comentarios -->
          <div *ngIf="commentsVisible[item.id]" class="comments-area">
            <div *ngFor="let c of item.comments">
              <p class="comment-text">{{ c.text }}</p>
              <small class="comment-meta">{{ c.date | date:'short' }}</small>
            </div>
            <ion-item lines="none" class="comment-composer">
              <ion-textarea
                autoGrow="true"
                rows="2"
                maxlength="500"
                [(ngModel)]="commentInput[item.id]"
                placeholder="Escribe tu comentario aquí..."
                aria-label="Campo de comentario"
              ></ion-textarea>
              <ion-button size="small" fill="solid" (click)="addComment(item.id)">Enviar</ion-button>
            </ion-item>
          </div>
        </ion-label>

        <ion-buttons slot="end" class="post-actions">
          <ion-button 
            fill="clear" 
            (click)="vote(item.id, 1)"
            [class.voted-up]="getUserVote(item.id) === 1"
          >
            <ion-icon slot="icon-only" name="chevron-up"></ion-icon>
          </ion-button>
          <div class="vote-count">{{ item.votes || 0 }}</div>
          <ion-button 
            fill="clear" 
            (click)="vote(item.id, -1)"
            [class.voted-down]="getUserVote(item.id) === -1"
          >
            <ion-icon slot="icon-only" name="chevron-down"></ion-icon>
          </ion-button>
          <ion-button fill="clear" (click)="toggleComments(item.id)">
            <ion-icon slot="icon-only" name="chatbubble-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-item>
    </ion-list>

    <!-- Mensaje cuando no hay publicaciones -->
    <div *ngIf="items.length === 0" class="empty-state">
      <p class="empty-state-text">La niebla no permite ver nuevas publicaciones- Espera que se acerquen</p>
    </div>

    <ion-infinite-scroll (ionInfinite)="loadData($event)">
      <ion-infinite-scroll-content loadingSpinner="bubbles" loadingText="Cargando más contenido...">
      </ion-infinite-scroll-content>
    </ion-infinite-scroll>
  </section>
</ion-content>

<ion-footer collapse="fade">
  <ion-toolbar>
    <p class="ion-padding-start">Caleuche Network 2025 ©</p>
  </ion-toolbar>
</ion-footer>
